<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.90.1"><link rel=canonical type=text/html href=https://nimbolus.de/terraform-modules/tf-vault/>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Terraform Vault | Nimbolus</title>
<meta name=description content="Nimbolus Documentation"><meta property="og:title" content="Terraform Vault">
<meta property="og:description" content="Provision a HA Vault cluster with Consul storage and auto unseal.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://nimbolus.de/terraform-modules/tf-vault/"><meta property="og:image" content="https://nimbolus.de/logo/nimbolus_red_512.png"><meta property="og:site_name" content="Nimbolus">
<meta itemprop=name content="Terraform Vault">
<meta itemprop=description content="Provision a HA Vault cluster with Consul storage and auto unseal."><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://nimbolus.de/logo/nimbolus_red_512.png">
<meta name=twitter:title content="Terraform Vault">
<meta name=twitter:description content="Provision a HA Vault cluster with Consul storage and auto unseal.">
<link rel=preload href=/scss/main.min.ac38ffe615d1321a852fd501193419b46560bd8c15779ec7c60b87bcec2251ea.css as=style>
<link href=/scss/main.min.ac38ffe615d1321a852fd501193419b46560bd8c15779ec7c60b87bcec2251ea.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg width="64mm" height="64mm" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><marker id="marker1954-3-3-8-0" overflow="visible" orient="auto"><path transform="matrix(.3 0 0 .3 -.69 0)" d="m8.7186 4.0337L-2.2074.016l10.926-4.0177c-1.7455 2.3721-1.7354 5.6175-6e-7 8.0354z" fill="#fff" fill-rule="evenodd" stroke="#fff" stroke-linejoin="round" stroke-width=".625"/></marker><marker id="marker1964-0-7-2-9" overflow="visible" orient="auto"><path transform="matrix(.3 0 0 .3 -.69 0)" d="m8.7186 4.0337L-2.2074.016l10.926-4.0177c-1.7455 2.3721-1.7354 5.6175-6e-7 8.0354z" fill="#fff" fill-rule="evenodd" stroke="#fff" stroke-linejoin="round" stroke-width=".625"/></marker></defs><g transform="translate(4.7684e-7 -96)"><rect x="1.0554" y="97.055" width="61.889" height="61.889" ry="3.9567" fill="#af0000" stroke="#af0000" stroke-width="2.1109"/><text x="12.197939" y="136.81088" fill="#fff" font-family="sans-serif" font-size="9.521" letter-spacing="0" stroke-width=".48973" word-spacing="0" style="line-height:1.25"><tspan x="12.197939" y="136.81088" fill="#fff" font-family="Roboto" font-size="9.521" font-weight="500" stroke-width=".48973">nimbolus</tspan></text><switch transform="matrix(.59037 0 0 .59037 -.22693 98.706)" stroke="#fff" stroke-width="3.8572"><g transform="translate(4.5878 -1.5774)" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round"><g stroke-width="3.8572"><path d="m52.923 75H17.6c-7.2.0-13-6.4-13-13.5.0-7.2 5.8-13.2 13-13.2.8.0 1.5-.1 2.3.1.4-8.8 7.1-15.8 15.2-15.8 2.35.0 4.55.55 6.5125 1.55S45.3 36.6 46.7 38.4" marker-start="url(#marker1954-3-3-8-0)" style="mix-blend-mode:normal"/><path d="m51.313 31.149c4.264-3.7548.46823-1.0679 1.9745-2.2366C56.3 26.5749 60 25.1999 63.9995 25.1999c10.1.0 18.3 8.9 18.3 19.9.0 1-.1 2.1-.2 3 .1.0.1.3.2.3 7.2-.2 13.1 5.9 13.1 13.1s-5.8 13.5-13 13.5h-21.386" marker-start="url(#marker1964-0-7-2-9)" style="mix-blend-mode:normal"/></g><path d="m66.336 30.269c3.5471 1.4524 10.678 4.5894 10.814 15.159" stroke-width="2.4286" style="mix-blend-mode:normal"/><path d="m8.8618 61.644c.71672-3.8601 2.7685-6.66 5.334-7.6148" stroke-width="2.4286" style="mix-blend-mode:normal"/></g><foreignObject width="1" height="1" requiredExtensions="http://ns.adobe.com/AdobeIllustrator/10.0/"/><text x="18.69075" y="66.653198" fill="#000" font-family="sans-serif" font-size="22.175" letter-spacing="0" stroke="#fff" stroke-width="2.9159" word-spacing="0" style="line-height:1.25"><tspan x="18.69075" y="66.653198" font-size="14.111" stroke="#fff" stroke-width="2.9159">nimbolus</tspan></text></switch></g></svg></span><span class="text-uppercase font-weight-bold">Nimbolus</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/><span class=active>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://github.com/nimbolus/ target=_blank><i class="fab fa-github"></i><span>GitHub</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/terraform-modules/tf-vault/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Terraform Vault</h1>
<div class=lead>Provision a HA Vault cluster with Consul storage and auto unseal.</div>
<ul>
</ul>
<div class=content>
<p><a href=https://github.com/nimbolus/tf-vault.git>View on GitHub</a></p>
<p>These Terraform modules can provision a highly available Vault cluster with the Consul storage backend.</p>
<p>You can use the <a href=https://github.com/nimbolus/tf-vault/tree/master/vault-consul>vault-consul</a> module to deploy the Vault cluster using a pre-existing Consul installation.
The <a href=https://github.com/nimbolus/tf-vault/tree/master/vault-transit>vault-transit</a> module can be used to setup the transit engine used for auto-unsealing another Vault cluster (they rely on each other for auto-unsealing).</p>
<h2 id=usage>Usage</h2>
<ol>
<li>Deploy Vault 1 (e.g. with vault-consul) - do NOT enable auto-unseal yet.</li>
<li>Repeat for Vault 2.</li>
<li>Deploy vault-transit for Vault 1 and Vault 2.</li>
<li>Enable auto-unseal for Vault 1 and init seal migration. You need to restart the Vault server pods.</li>
<li>Repeat for Vault 2.</li>
</ol>
<h2 id=examples>Examples</h2>
<h3 id=ha-vault-with-consul-storage>HA Vault with Consul storage</h3>
<p><a href=https://github.com/nimbolus/tf-vault/tree/master/examples/vault-auto-unseal/main.tf>View on GitHub</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;vault1&#34;</span> {
  <span style=color:#a6e22e>source</span>                            = <span style=color:#e6db74>&#34;github.com/nimbolus/tf-vault/vault-consul&#34;</span>
  <span style=color:#a6e22e>release_name</span>                      = <span style=color:#e6db74>&#34;vault1&#34;</span>
  <span style=color:#a6e22e>namespace</span>                         = <span style=color:#a6e22e>kubernetes_namespace</span>.<span style=color:#a6e22e>vault</span>.<span style=color:#a6e22e>metadata</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>name</span>
  <span style=color:#a6e22e>vault_domain</span>                      = yamldecode(<span style=color:#a6e22e>kubectl_manifest</span>.<span style=color:#a6e22e>vault1_certificate</span>.<span style=color:#a6e22e>yaml_body_parsed</span>)[<span style=color:#e6db74>&#34;spec&#34;</span>][<span style=color:#e6db74>&#34;dnsNames&#34;</span>][<span style=color:#ae81ff>0</span>]
  <span style=color:#a6e22e>consul_address</span>                    = <span style=color:#e6db74>&#34;consul.example.com&#34;</span>
  <span style=color:#a6e22e>auto_unseal_enable</span>                = <span style=color:#66d9ef>true</span>
  <span style=color:#a6e22e>auto_unseal_vault_service_address</span> = <span style=color:#e6db74>&#34;https://vault2.example.com&#34;</span>
  <span style=color:#a6e22e>auto_unseal_vault_mount_path</span>      = <span style=color:#e6db74>&#34;vault-transit&#34;</span>
  <span style=color:#a6e22e>auto_unseal_vault_role</span>            = <span style=color:#e6db74>&#34;vault-unseal&#34;</span>
  <span style=color:#a6e22e>tls_secret_name</span>                   = yamldecode(<span style=color:#a6e22e>kubectl_manifest</span>.<span style=color:#a6e22e>vault1_certificate</span>.<span style=color:#a6e22e>yaml_body_parsed</span>)[<span style=color:#e6db74>&#34;spec&#34;</span>][<span style=color:#e6db74>&#34;secretName&#34;</span>]
  <span style=color:#a6e22e>ingress_ssl_passthrough_enable</span>    = <span style=color:#66d9ef>true</span>
}
</code></pre></div><h3 id=transit-secret-engine-for-auto-unseal>Transit Secret Engine for Auto Unseal</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;vault_transit1&#34;</span> {
  <span style=color:#a6e22e>depends_on</span> = [module.<span style=color:#a6e22e>vault1</span>]
  <span style=color:#a6e22e>providers</span> = {
    <span style=color:#a6e22e>vault</span> = <span style=color:#a6e22e>vault</span>.<span style=color:#a6e22e>vault1</span>
   }
  <span style=color:#a6e22e>source</span>    = <span style=color:#e6db74>&#34;github.com/nimbolus/tf-vault/vault-transit&#34;</span>
  <span style=color:#a6e22e>name</span>      = <span style=color:#e6db74>&#34;vault2&#34;</span>
  <span style=color:#a6e22e>namespace</span> = <span style=color:#e6db74>&#34;vault2&#34;</span>
}
</code></pre></div>
</div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 Nimbolus All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity=sha384-uQikAXnCAqsMb3ygtdqBYvcwvHUkzGIpjdGyy9owhURXHUxLC5LgTcSxJQH/RzjK crossorigin=anonymous></script>
<script src=/js/main.min.5e331f8640e0271b7a1294ff012ab8bffaa1445c9e9c86d7fc138db2e8341262.js integrity="sha256-XjMfhkDgJxt6EpT/ASq4v/qhRFyenIbX/BONsug0EmI=" crossorigin=anonymous></script>
</body>
</html>